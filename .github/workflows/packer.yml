# This is a basic workflow to help you get started with Actions
name: DeployToAWS
# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch.
  push:
    branches: [ main ]
 
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build:
    name: workflow_aws
    runs-on: ubuntu-latest
    outputs:
      ID_OF_AMI: ${{steps.AMI_ID_OUTPUT.outputs.ID_OF_AMI}}

    strategy:
      matrix:
        node-version: [18.x]


    steps:
      - uses: actions/checkout@v3
      - name: Run a one-line script
        run: echo Hello, world!
      # Runs a set of commands using the runners shell
      - name: Run a multi-line script
        run: |
          echo Add other actions to build,
          echo test, and deploy your project.
      - name: Setup Packer
        uses: hashicorp-contrib/setup-packer@v1.0.0
      - name: Run packer commands
        run: |
          zip -r webApp.zip ./
          pwd ./webApp
          packer build  -var-file="vars.json" ami.json.pkr.hcl
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}          
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

      - name: Getting AMI id as outputs
        id: AMI_ID_OUTPUT
        run: |
          ID_OF_AMI=$(jq -r '.builds[-1].artifact_id' manifest.json | cut -d ":" -f2)
          echo $ID_OF_AMI
          echo "ID_OF_AMI=$ID_OF_AMI" >> "$GITHUB_OUTPUT"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}          
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}